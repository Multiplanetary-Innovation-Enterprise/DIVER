# Creates a new release when
name: Create Release

# Controls when the workflow will run
on:
  # Triggers the release creation when changes are pushed onto the master branch
  push:
    branches: [ "master" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# The list of tasks to perform
jobs:
  # Builds the messaging library
  build-messaging-library:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: ./.github/actions/setup-release
     
     # Builds the messaging library
      - name: Build Messaging
        run: |
          cd "Common/Messaging"
          python setup.py bdist_wheel
        
        
      - name: Rename file  
        # Move into the distribution folder where the build files are
        run: |
          cd "Common/Messaging/dist"
          ls

          # Rename the library file that was created
          mv *.whl messaging-library.whl
        
          ls
          
      # Upload the built library as an artafact
      - name: Upload messaging library
        uses: actions/upload-artifact@v3
        with:
          name: messaging-library
          path: messaging-library.whl
          retention-days: 1

  # Builds the netowrking library
  build-networking-library:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - uses: ./.github/actions/setup-release
      
      # Builds the netowrking library
      - name: Build Networking
        run: |
          cd "Common/Connections"
          python setup.py bdist_wheel
         
          # Move into the distribution folder where the build files are
          cd dist

          # Rename the library file that was created
          mv *.whl networking-library.whl
          
        # Upload the built library as an artafact
      - name: Upload networking library
        uses: actions/upload-artifact@v3
        with:
          name: networking-library
          path: networking-library.whl
          retention-days: 1


  # Creates the executables for the ROV and Client Programs
#  build-applications:
      # The type of runner that the job will run on
   #   runs-on: ubuntu-latest

       # TODO

  #Creates the actual release
  create-release:
      # The type of runner that the job will run on
      runs-on: ubuntu-latest
      needs: [build-messaging-library, build-networking-library]

      steps:
        - uses: actions/checkout@v3
        - uses: ./.github/actions/setup-release

        - name: Download artifacts
          uses: actions/download-artifact@v3
          with:
            name: messaging-library, networking-library

        - run: echo "Creating release"
        - run: |
            ls
